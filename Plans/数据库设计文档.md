# 餐食关系系统数据库设计文档

## 1. 数据库概述

### 1.1 数据库选择
- **主数据库**：MySQL（可靠稳定，适合企业级应用）
- **备份存储**：本地文件系统 + 云存储

### 1.2 设计原则
- **规范化设计**：遵循第三范式，减少数据冗余
- **完整性约束**：确保数据的一致性和有效性
- **可扩展性**：支持未来功能扩展
- **性能优化**：合理设计索引，优化查询性能

## 2. 核心表结构

### 2.1 用户表（users）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 用户ID |
| username | VARCHAR(50) | UNIQUE NOT NULL | 用户名 |
| password_hash | VARCHAR(255) | NOT NULL | 密码哈希 |
| role | VARCHAR(20) | NOT NULL | 角色（customer/employee/admin） |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| last_login | DATETIME | | 最后登录时间 |

### 2.2 客户表（customers）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 客户ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| name | VARCHAR(50) | NOT NULL | 姓名 |
| age | INTEGER | | 年龄 |
| gender | VARCHAR(10) | | 性别 |
| contact | VARCHAR(100) | | 联系方式 |
| delivery_date | DATE | | 预产期/分娩日期 |
| check_in_date | DATE | | 入住日期 |
| check_out_date | DATE | | 退房日期 |
| dietary_restrictions | TEXT | | 饮食禁忌 |
| preferences | TEXT | | 口味偏好 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active/inactive） |

### 2.3 菜品表（dishes）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 菜品ID |
| name | VARCHAR(100) | NOT NULL | 菜品名称 |
| category | VARCHAR(50) | NOT NULL | 分类（汤品/点心/肉菜/蔬菜等） |
| description | TEXT | | 描述 |
| ingredients | TEXT | | 食材组成 |
| restrictions | TEXT | | 禁忌食材 |
| calories | INTEGER | | 卡路里 |
| price | DECIMAL(10,2) | | 价格 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active/inactive） |

### 2.4 菜单表（menus）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 菜单ID |
| date | DATE | NOT NULL | 日期 |
| type | VARCHAR(20) | NOT NULL | 类型（breakfast/lunch/dinner） |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active/inactive） |

### 2.5 菜单菜品关联表（menu_dishes）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ID |
| menu_id | INTEGER | REFERENCES menus(id) | 菜单ID |
| dish_id | INTEGER | REFERENCES dishes(id) | 菜品ID |
| quantity | INTEGER | NOT NULL | 数量 |

### 2.6 客户菜单关联表（customer_menus）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ID |
| customer_id | INTEGER | REFERENCES customers(id) | 客户ID |
| menu_id | INTEGER | REFERENCES menus(id) | 菜单ID |
| status | VARCHAR(20) | DEFAULT 'delivered' | 状态（delivered/cancelled） |
| feedback | TEXT | | 反馈 |
| rating | INTEGER | | 评分（1-5） |

### 2.7 食材表（ingredients）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 食材ID |
| name | VARCHAR(100) | NOT NULL | 食材名称 |
| category | VARCHAR(50) | NOT NULL | 分类 |
| unit | VARCHAR(20) | NOT NULL | 单位 |
| current_stock | DECIMAL(10,2) | DEFAULT 0 | 当前库存 |
| minimum_stock | DECIMAL(10,2) | DEFAULT 0 | 最低库存 |
| supplier_id | INTEGER | REFERENCES suppliers(id) | 供应商ID |
| price | DECIMAL(10,2) | | 单价 |
| expiry_date | DATE | | 保质期 |
| nutrition_info | TEXT | | 营养成分 |
| calories | DECIMAL(8,2) | | 热量 |
| restrictions | TEXT | | 禁忌信息 |
| purchaser | VARCHAR(50) | | 购买人 |
| origin | TEXT | | 食材溯源 |

### 2.8 员工表（employees）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 员工ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| name | VARCHAR(50) | NOT NULL | 姓名 |
| position | VARCHAR(50) | NOT NULL | 职位 |
| contact | VARCHAR(100) | | 联系方式 |
| base_salary | DECIMAL(10,2) | NOT NULL | 基础薪资 |
| joining_date | DATE | NOT NULL | 入职日期 |
| education | TEXT | | 学历 |
| work_experience | TEXT | | 工作经历 |
| work_performance | TEXT | | 工作业绩 |
| status | VARCHAR(20) | DEFAULT 'active' | 状态（active/inactive） |

### 2.9 供应商表（suppliers）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 供应商ID |
| name | VARCHAR(100) | NOT NULL | 供应商名称 |
| contact_person | VARCHAR(50) | NOT NULL | 联系人 |
| contact_phone | VARCHAR(20) | NOT NULL | 联系电话 |
| address | TEXT | | 地址 |
| products | TEXT | | 供应产品 |
| rating | DECIMAL(3,1) | DEFAULT 0 | 评分 |

## 3. 财务系统表结构

### 3.1 收支记录表（transactions）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 交易ID |
| type | VARCHAR(20) | NOT NULL | 类型（income/expense） |
| category | VARCHAR(50) | NOT NULL | 分类 |
| amount | DECIMAL(10,2) | NOT NULL | 金额 |
| description | TEXT | | 描述 |
| transaction_date | DATETIME | DEFAULT CURRENT_TIMESTAMP | 交易日期 |
| payment_method | VARCHAR(20) | | 支付方式（wechat/alipay/bank/cash） |
| status | VARCHAR(20) | DEFAULT 'completed' | 状态（pending/completed/cancelled） |
| related_id | INTEGER | | 关联ID（客户ID/员工ID/供应商ID） |
| related_type | VARCHAR(20) | | 关联类型（customer/employee/supplier） |

### 3.2 客户订单表（customer_orders）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 订单ID |
| customer_id | INTEGER | REFERENCES customers(id) | 客户ID |
| order_date | DATETIME | DEFAULT CURRENT_TIMESTAMP | 订单日期 |
| delivery_date | DATE | | 配送日期 |
| start_time | TIME | | 开始时间 |
| end_time | TIME | | 结束时间 |
| duration | DECIMAL(5,2) | | 时长 |
| order_type | VARCHAR(20) | NOT NULL | 订单类型（meal/service） |
| total_amount | DECIMAL(10,2) | NOT NULL | 总金额 |
| payment_status | VARCHAR(20) | DEFAULT 'pending' | 支付状态（pending/paid/cancelled） |
| payment_method | VARCHAR(20) | | 支付方式 |
| transaction_id | INTEGER | REFERENCES transactions(id) | 交易ID |
| status | VARCHAR(20) | DEFAULT 'pending' | 订单状态（pending/confirmed/completed/cancelled） |
| booker_name | VARCHAR(50) | | 预定人姓名 |
| booker_role | VARCHAR(20) | | 预定人角色（customer/employee/nutritionist） |
| service_employee_id | INTEGER | REFERENCES employees(id) | 服务员工ID |
| delivery_address | TEXT | | 配送地址 |
| notes | TEXT | | 备注 |
| rating | INTEGER | | 评分（1-5） |
| feedback | TEXT | | 评价反馈 |

### 3.3 订单明细表（order_items）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 明细ID |
| order_id | INTEGER | REFERENCES customer_orders(id) | 订单ID |
| item_type | VARCHAR(20) | NOT NULL | 项目类型（dish/service） |
| item_id | INTEGER | | 项目ID（菜品ID/服务ID） |
| quantity | INTEGER | NOT NULL | 数量 |
| unit_price | DECIMAL(10,2) | NOT NULL | 单价 |
| subtotal | DECIMAL(10,2) | NOT NULL | 小计 |

### 3.4 员工考勤表（attendance）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 考勤ID |
| employee_id | INTEGER | REFERENCES employees(id) | 员工ID |
| date | DATE | NOT NULL | 日期 |
| check_in_time | TIME | | 上班时间 |
| check_out_time | TIME | | 下班时间 |
| work_hours | DECIMAL(5,2) | | 工作时长 |
| status | VARCHAR(20) | DEFAULT 'present' | 状态（present/absent/leave） |
| notes | TEXT | | 备注 |

### 3.5 员工工作量表（workload）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 工作量ID |
| employee_id | INTEGER | REFERENCES employees(id) | 员工ID |
| date | DATE | NOT NULL | 日期 |
| work_type | VARCHAR(20) | NOT NULL | 工作类型（normal/overtime/accompany/care） |
| hours | DECIMAL(5,2) | NOT NULL | 工作时长 |
| description | TEXT | | 描述 |
| rate_multiplier | DECIMAL(3,2) | DEFAULT 1.0 | 薪资倍率 |

### 3.6 员工薪资表（salary）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 薪资ID |
| employee_id | INTEGER | REFERENCES employees(id) | 员工ID |
| pay_period | VARCHAR(20) | NOT NULL | 薪资周期 |
| base_salary | DECIMAL(10,2) | NOT NULL | 基础薪资 |
| overtime_pay | DECIMAL(10,2) | DEFAULT 0 | 加班费 |
| allowance | DECIMAL(10,2) | DEFAULT 0 | 津贴 |
| deductions | DECIMAL(10,2) | DEFAULT 0 | 扣除项 |
| net_salary | DECIMAL(10,2) | NOT NULL | 实发薪资 |
| payment_date | DATE | | 发放日期 |
| transaction_id | INTEGER | REFERENCES transactions(id) | 交易ID |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态（pending/paid） |

### 3.7 采购订单表（purchase_orders）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 订单ID |
| supplier_id | INTEGER | REFERENCES suppliers(id) | 供应商ID |
| order_date | DATE | NOT NULL | 订单日期 |
| expected_delivery | DATE | | 预计送达日期 |
| total_amount | DECIMAL(10,2) | NOT NULL | 总金额 |
| status | VARCHAR(20) | DEFAULT 'pending' | 状态（pending/delivered/cancelled） |
| transaction_id | INTEGER | REFERENCES transactions(id) | 交易ID |

### 3.8 采购订单明细表（purchase_order_items）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 明细ID |
| order_id | INTEGER | REFERENCES purchase_orders(id) | 订单ID |
| ingredient_id | INTEGER | REFERENCES ingredients(id) | 食材ID |
| quantity | DECIMAL(10,2) | NOT NULL | 数量 |
| unit_price | DECIMAL(10,2) | NOT NULL | 单价 |
| subtotal | DECIMAL(10,2) | NOT NULL | 小计 |

## 4. 支付系统表结构

### 4.1 支付交易表（payment_transactions）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 交易ID |
| transaction_id | INTEGER | REFERENCES transactions(id) | 关联交易ID |
| payment_method | VARCHAR(20) | NOT NULL | 支付方式（wechat/alipay/bank） |
| payment_amount | DECIMAL(10,2) | NOT NULL | 支付金额 |
| transaction_status | VARCHAR(20) | DEFAULT 'pending' | 交易状态（pending/success/failed） |
| transaction_time | DATETIME | | 交易时间 |
| transaction_id_external | VARCHAR(100) | | 外部交易ID |
| error_message | TEXT | | 错误信息 |

## 5. 数据安全表结构

### 5.1 操作日志表（operation_logs）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 日志ID |
| user_id | INTEGER | REFERENCES users(id) | 用户ID |
| operation_type | VARCHAR(50) | NOT NULL | 操作类型 |
| operation_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 操作时间 |
| ip_address | VARCHAR(50) | | IP地址 |
| user_agent | TEXT | | 用户代理 |
| details | TEXT | | 操作详情 |
| status | VARCHAR(20) | DEFAULT 'success' | 状态（success/failed） |

### 5.2 权限表（permissions）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 权限ID |
| name | VARCHAR(50) | UNIQUE NOT NULL | 权限名称 |
| description | TEXT | | 权限描述 |

### 5.3 角色权限关联表（role_permissions）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | ID |
| role | VARCHAR(20) | NOT NULL | 角色 |
| permission_id | INTEGER | REFERENCES permissions(id) | 权限ID |

### 5.4 数据备份表（backups）
| 字段名 | 数据类型 | 约束 | 描述 |
|-------|---------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 备份ID |
| backup_time | DATETIME | DEFAULT CURRENT_TIMESTAMP | 备份时间 |
| backup_path | TEXT | NOT NULL | 备份路径 |
| backup_size | BIGINT | | 备份大小 |
| status | VARCHAR(20) | DEFAULT 'success' | 状态（success/failed） |
| notes | TEXT | | 备注 |

## 6. 表关系图

```
+----------------+     +----------------+     +----------------+
|    users       |     |   customers    |     | customer_orders|
+----------------+     +----------------+     +----------------+
| id (PK)        |<----| user_id (FK)   |<----| customer_id (FK)|
| username       |     | id (PK)        |     | id (PK)        |
| password_hash  |     | name           |     | order_date     |
| role           |     | contact        |     | total_amount   |
+----------------+     +----------------+     +----------------+
         ^                      ^                      |
         |                      |                      |
         v                      v                      v
+----------------+     +----------------+     +----------------+
|   employees    |     |    suppliers   |     | order_items    |
+----------------+     +----------------+     +----------------+
| id (PK)        |<----| id (PK)        |<----| id (PK)        |
| user_id (FK)   |     | name           |     | order_id (FK)  |
| name           |     | contact_person |     | item_type      |
| base_salary    |     +----------------+     +----------------+
+----------------+                      |
         ^                              |
         |                              |
         v                              v
+----------------+     +----------------+     +----------------+
|  attendance    |     |  workload      |     |  salary        |
+----------------+     +----------------+     +----------------+
| id (PK)        |     | id (PK)        |     | id (PK)        |
| employee_id (FK)|<----| employee_id (FK)|<----| employee_id (FK)|
| date           |     | date           |     | pay_period     |
| work_hours     |     | work_type      |     | net_salary     |
+----------------+     | hours          |     +----------------+
                       +----------------+             |
                              ^                       |
                              |                       v
                       +----------------+     +----------------+
                       |  transactions  |<----| payment_transactions|
                       +----------------+     +----------------+
                       | id (PK)        |     | id (PK)        |
                       | type           |     | payment_method |
                       | amount         |     | transaction_status|
                       | transaction_date|    +----------------+
                       +----------------+            ^
                              ^                      |
                              |                      |
                              v                      v
                       +----------------+     +----------------+
                       | purchase_orders|     | operation_logs |
                       +----------------+     +----------------+
                       | id (PK)        |     | id (PK)        |
                       | supplier_id (FK)|    | user_id (FK)   |
                       | order_date     |    | operation_type |
                       | total_amount   |    | operation_time |
                       +----------------+     +----------------+
                              |
                              v
                       +----------------+
                       | purchase_order_items|
                       +----------------+
                       | id (PK)        |
                       | order_id (FK)  |
                       | ingredient_id (FK)|
                       | quantity       |
                       +----------------+
                              |
                              v
                       +----------------+
                       |   ingredients  |
                       +----------------+
                       | id (PK)        |
                       | name           |
                       | category       |
                       | current_stock  |
                       +----------------+
                              |
                              v
                       +----------------+
                       |    dishes      |
                       +----------------+
                       | id (PK)        |
                       | name           |
                       | category       |
                       | ingredients    |
                       +----------------+
                              |
                              v
                       +----------------+
                       | menu_dishes    |
                       +----------------+
                       | id (PK)        |
                       | menu_id (FK)   |
                       | dish_id (FK)   |
                       | quantity       |
                       +----------------+
                              ^
                              |
                              v
                       +----------------+
                       |    menus       |
                       +----------------+
                       | id (PK)        |
                       | date           |
                       | type           |
                       +----------------+
                              |
                              v
                       +----------------+
                       | customer_menus |
                       +----------------+
                       | id (PK)        |
                       | customer_id (FK)|
                       | menu_id (FK)   |
                       | status         |
                       +----------------+
```

## 3. 索引设计

### 3.1 主键索引
- 所有表的id字段均为主键，自动创建索引

### 3.2 外键索引
- users.id → customers.user_id, employees.user_id
- customers.id → customer_orders.customer_id, customer_menus.customer_id
- employees.id → attendance.employee_id, workload.employee_id, salary.employee_id
- suppliers.id → ingredients.supplier_id, purchase_orders.supplier_id
- dishes.id → menu_dishes.dish_id, order_items.item_id
- menus.id → menu_dishes.menu_id, customer_menus.menu_id
- transactions.id → payment_transactions.transaction_id

### 3.3 其他索引
| 表名 | 索引字段 | 类型 | 描述 |
|------|---------|------|------|
| users | username | UNIQUE | 加速用户登录查询 |
| customers | name, contact | 普通 | 加速客户信息查询 |
| employees | name, position | 普通 | 加速员工信息查询 |
| dishes | name, category | 普通 | 加速菜品查询 |
| ingredients | name, category | 普通 | 加速食材查询 |
| transactions | transaction_date, type | 普通 | 加速交易记录查询 |
| attendance | employee_id, date | 普通 | 加速考勤记录查询 |
| workload | employee_id, date, work_type | 普通 | 加速工作量统计查询 |

## 4. 视图设计

### 4.1 客户消费视图（customer_spending_view）
- 汇总客户的消费记录
- 包含客户信息、总消费金额、最近消费日期

### 4.2 员工工作量视图（employee_workload_view）
- 汇总员工的工作量统计
- 包含员工信息、总工作时长、加班时长、陪护时长、护理时长

### 4.3 食材库存预警视图（inventory_alert_view）
- 显示低于最低库存的食材
- 包含食材信息、当前库存、最低库存、供应商信息

### 4.4 财务报表视图（financial_report_view）
- 汇总收支记录
- 按日期、类型、分类统计收支金额

## 5. 存储过程与触发器

### 5.1 存储过程

#### 5.1.1 计算员工薪资（calculate_salary）
- **功能**：根据员工的工作量记录计算薪资
- **参数**：员工ID、薪资周期
- **返回**：计算后的薪资详情

#### 5.1.2 生成采购清单（generate_purchase_list）
- **功能**：根据食材库存和排餐需求生成采购清单
- **参数**：日期范围
- **返回**：采购清单详情

#### 5.1.3 备份数据库（backup_database）
- **功能**：备份数据库到指定路径
- **参数**：备份路径
- **返回**：备份状态

### 5.2 触发器

#### 5.2.1 食材库存更新触发器
- **触发条件**：采购订单状态变为已送达时
- **操作**：更新对应食材的库存

#### 5.2.2 工作量统计触发器
- **触发条件**：考勤记录更新时
- **操作**：自动计算工作时长并更新工作量记录

#### 5.2.3 交易记录触发器
- **触发条件**：支付交易状态变为成功时
- **操作**：更新对应交易记录的状态

## 6. 数据安全考虑

### 6.1 敏感数据保护
- **密码**：使用bcrypt等算法加密存储
- **个人信息**：客户和员工的敏感信息加密存储
- **财务数据**：交易记录和薪资信息加密存储

### 6.2 访问控制
- **基于角色的访问控制**：不同角色拥有不同的权限
- **数据访问限制**：员工只能访问自己的考勤和工作量记录
- **管理员权限**：管理员可以访问所有数据

### 6.3 数据备份与恢复
- **自动备份**：每日自动备份数据库
- **备份策略**：保留最近7天的备份，每周生成一次完整备份
- **恢复机制**：支持从指定备份点恢复数据

## 7. 性能优化

### 7.1 查询优化
- **合理使用索引**：为频繁查询的字段创建索引
- **避免全表扫描**：使用WHERE子句限制查询范围
- **优化JOIN操作**：合理设计表关系，减少JOIN操作的复杂度

### 7.2 存储优化
- **数据压缩**：对历史数据进行压缩存储
- **分区表**：对大型表进行分区，提高查询性能
- **定期清理**：清理过期数据，释放存储空间

### 7.3 缓存策略
- **应用级缓存**：缓存频繁访问的数据
- **查询缓存**：缓存常用查询的结果
- **会话缓存**：缓存用户会话信息

## 8. 总结

本数据库设计文档详细描述了餐食关系系统的数据库结构，包括核心表、财务系统表、支付系统表和数据安全表。设计充分考虑了系统的功能需求，特别是财务统计和员工工作量计算的需求，确保数据的一致性、完整性和安全性。

数据库结构遵循规范化设计原则，减少数据冗余，同时通过合理的索引设计和性能优化措施，确保系统的查询性能和响应速度。表关系设计清晰，支持复杂的业务逻辑和数据统计需求。

通过本数据库设计，可以为餐食关系系统提供稳定、高效、安全的数据存储和管理能力，支持系统的正常运行和未来的功能扩展。