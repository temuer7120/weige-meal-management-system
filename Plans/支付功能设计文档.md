# 餐食关系系统支付功能设计文档

## 1. 系统概述

### 1.1 设计目标
- **多渠道支付**：支持微信支付、支付宝、银行卡等多种支付方式
- **全场景覆盖**：支持客户预定、餐费支付、员工薪资发放、供应商付款等场景
- **安全可靠**：确保支付过程的安全性和可靠性
- **便捷高效**：提供简洁的支付流程，提升用户体验
- **实时对账**：实现支付交易的实时对账和管理
- **自动化处理**：支持批量支付和自动处理

### 1.2 核心功能
- **支付订单管理**：创建、查询、取消支付订单
- **多渠道支付**：集成微信支付、支付宝、银行卡支付
- **交易管理**：记录和管理所有支付交易
- **对账功能**：与支付平台进行对账
- **退款管理**：处理支付退款
- **批量支付**：支持员工薪资批量发放、供应商批量付款

### 1.3 技术架构
- **前端**：响应式Web界面、微信小程序
- **后端**：Flask RESTful API
- **支付网关**：集成第三方支付API
- **数据库**：MySQL，存储支付交易记录
- **消息队列**：处理异步支付通知

## 2. 支付场景设计

### 2.1 客户预支付

#### 2.1.1 场景描述
- 客户通过微信小程序或Web端进行服务预约
- 预约时需要支付一定金额的定金
- 支付成功后，预约状态更新为已支付

#### 2.1.2 流程设计
1. **预约申请**：客户选择服务类型、日期、时间
2. **生成订单**：系统生成预约订单，计算定金金额
3. **选择支付方式**：客户选择微信支付、支付宝或银行卡
4. **发起支付**：系统调用对应支付平台的API
5. **完成支付**：客户在支付平台完成支付
6. **支付回调**：支付平台通知系统支付结果
7. **订单更新**：系统更新预约订单状态为已支付
8. **通知客户**：通过短信、微信通知客户支付结果

#### 2.1.3 业务规则
- 定金金额：根据服务类型和金额的一定比例计算
- 支付时限：生成支付订单后30分钟内完成支付
- 过期处理：超过支付时限，订单自动取消
- 退款规则：预约取消时，根据取消时间计算退款金额

### 2.2 餐费支付

#### 2.2.1 场景描述
- 客户入住期间的餐费结算
- 客户退房时的总费用结算
- 支持单次支付和批量支付

#### 2.2.2 流程设计
1. **费用计算**：系统根据客户的实际消费计算餐费总额
2. **生成账单**：系统生成详细的费用账单
3. **选择支付方式**：客户选择支付方式
4. **发起支付**：系统调用支付平台API
5. **完成支付**：客户完成支付
6. **支付回调**：支付平台通知系统支付结果
7. **账单更新**：系统更新账单状态为已支付
8. **开具发票**：根据客户需求开具发票

#### 2.2.3 业务规则
- 支付方式：支持微信支付、支付宝、银行卡
- 支付时限：账单生成后24小时内完成支付
- 逾期处理：超过支付时限，系统发送提醒通知
- 发票规则：支持电子发票和纸质发票

### 2.3 员工薪资发放

#### 2.3.1 场景描述
- 每月固定日期发放员工薪资
- 支持通过银行转账、微信支付、支付宝发放
- 提供薪资明细查询

#### 2.3.2 流程设计
1. **薪资计算**：系统根据员工工作量计算薪资
2. **薪资审核**：财务人员审核薪资计算结果
3. **批量支付**：系统生成批量支付订单
4. **选择支付方式**：根据员工选择的支付方式进行发放
5. **发起支付**：系统调用支付平台API发起批量支付
6. **支付处理**：支付平台处理批量支付请求
7. **支付回调**：支付平台通知系统支付结果
8. **薪资更新**：系统更新员工薪资发放状态
9. **通知员工**：通过短信、微信通知员工薪资发放结果

#### 2.3.3 业务规则
- 发放周期：每月固定日期发放
- 支付方式：支持银行转账、微信支付、支付宝
- 到账时间：根据支付方式不同，到账时间为T+0或T+1
- 失败处理：支付失败时，系统自动重试并通知财务人员

### 2.4 供应商付款

#### 2.4.1 场景描述
- 向食材供应商、服务供应商支付款项
- 支持单次付款和批量付款
- 提供付款明细查询

#### 2.4.2 流程设计
1. **应付账款确认**：确认供应商的应付账款金额
2. **生成付款单**：系统生成付款单
3. **付款审批**：财务人员审批付款单
4. **选择支付方式**：根据供应商选择的支付方式
5. **发起支付**：系统调用支付平台API
6. **完成支付**：支付平台处理支付请求
7. **支付回调**：支付平台通知系统支付结果
8. **账款更新**：系统更新供应商账款状态
9. **通知供应商**：通过短信、邮件通知供应商付款结果

#### 2.4.3 业务规则
- 付款周期：根据合同约定的付款周期
- 支付方式：支持银行转账、微信支付、支付宝
- 审批流程：超过一定金额的付款需要多级审批
- 凭证管理：付款后生成付款凭证，支持电子凭证和纸质凭证

## 3. 支付方式集成

### 3.1 微信支付

#### 3.1.1 集成方案
- **API版本**：微信支付v3 API
- **接入方式**：
  - 小程序支付：通过微信小程序JSAPI支付
  - Web支付：通过Native支付生成二维码
  - 扫码支付：通过Native支付生成二维码

#### 3.1.2 核心接口
- **统一下单**：`/v3/pay/transactions/jsapi`（小程序）、`/v3/pay/transactions/native`（扫码）
- **查询订单**：`/v3/pay/transactions/out-trade-no/{out_trade_no}`
- **关闭订单**：`/v3/pay/transactions/out-trade-no/{out_trade_no}/close`
- **退款**：`/v3/refund/domestic/refunds`
- **支付通知**：接收微信支付平台的支付结果通知

#### 3.1.3 配置参数
| 参数名 | 描述 | 配置位置 |
|-------|------|----------|
| appid | 微信公众号或小程序ID | 系统配置 |
| mchid | 微信支付商户号 | 系统配置 |
| api_key | 微信支付API密钥 | 安全存储 |
| serial_no | 商户API证书序列号 | 系统配置 |
| private_key | 商户API私钥 | 安全存储 |
| public_key | 微信支付平台公钥 | 系统配置 |

### 3.2 支付宝

#### 3.2.1 集成方案
- **API版本**：支付宝开放平台API
- **接入方式**：
  - 手机支付：通过手机网站支付
  - Web支付：通过电脑网站支付
  - 扫码支付：通过当面付生成二维码

#### 3.2.2 核心接口
- **电脑网站支付**：`alipay.trade.page.pay`
- **手机网站支付**：`alipay.trade.wap.pay`
- **扫码支付**：`alipay.trade.precreate`
- **查询订单**：`alipay.trade.query`
- **关闭订单**：`alipay.trade.close`
- **退款**：`alipay.trade.refund`
- **支付通知**：接收支付宝平台的支付结果通知

#### 3.2.3 配置参数
| 参数名 | 描述 | 配置位置 |
|-------|------|----------|
| app_id | 支付宝应用ID | 系统配置 |
| merchant_private_key | 商户私钥 | 安全存储 |
| alipay_public_key | 支付宝公钥 | 系统配置 |
| sign_type | 签名类型 | 系统配置 |
| charset | 字符集 | 系统配置 |
| gateway_url | 支付宝网关地址 | 系统配置 |

### 3.3 银行卡支付

#### 3.3.1 集成方案
- **API版本**：第三方支付机构银行卡支付API
- **接入方式**：
  - 快捷支付：通过绑定银行卡进行支付
  - 网银支付：通过网上银行进行支付

#### 3.3.2 核心接口
- **快捷支付**：`/api/v1/pay/bank/quick`
- **网银支付**：`/api/v1/pay/bank/online`
- **查询订单**：`/api/v1/pay/query`
- **退款**：`/api/v1/pay/refund`
- **支付通知**：接收支付机构的支付结果通知

#### 3.3.3 配置参数
| 参数名 | 描述 | 配置位置 |
|-------|------|----------|
| merchant_id | 商户ID | 系统配置 |
| terminal_id | 终端ID | 系统配置 |
| api_key | API密钥 | 安全存储 |
| gateway_url | 支付网关地址 | 系统配置 |

## 4. 支付核心模块

### 4.1 支付订单管理

#### 4.1.1 订单生成
- **订单号生成**：采用时间戳+随机数的方式生成唯一订单号
- **订单参数**：包含金额、支付方式、订单类型、关联ID等信息
- **订单状态**：待支付、已支付、已取消、已退款

#### 4.1.2 订单查询
- **按订单号查询**：通过订单号查询订单详情
- **按用户查询**：查询用户的所有支付订单
- **按状态查询**：查询特定状态的订单
- **按时间查询**：查询特定时间段的订单

#### 4.1.3 订单取消
- **主动取消**：用户或管理员主动取消未支付的订单
- **自动取消**：超过支付时限的订单自动取消
- **取消规则**：已支付的订单不能直接取消，需要通过退款流程

### 4.2 交易管理

#### 4.2.1 交易记录
- **记录内容**：交易ID、订单号、支付方式、金额、交易状态、交易时间等
- **交易状态**：待处理、成功、失败、退款中、已退款
- **交易类型**：支付、退款、转账

#### 4.2.2 交易查询
- **按交易ID查询**：通过交易ID查询交易详情
- **按订单号查询**：查询订单相关的所有交易
- **按时间查询**：查询特定时间段的交易
- **按状态查询**：查询特定状态的交易

#### 4.2.3 交易统计
- **交易总额**：统计一定时间段内的交易总额
- **交易笔数**：统计一定时间段内的交易笔数
- **成功率**：计算交易成功率
- **支付方式分布**：统计不同支付方式的交易占比

### 4.3 对账管理

#### 4.3.1 对账流程
1. **数据获取**：从支付平台获取交易记录
2. **数据比对**：与系统内的交易记录进行比对
3. **差异处理**：处理对账差异
4. **对账报表**：生成对账结果报表

#### 4.3.2 对账周期
- **日对账**：每日与支付平台进行对账
- **周对账**：每周进行一次全面对账
- **月对账**：每月进行一次月度对账

#### 4.3.3 对账差异类型
- **金额差异**：交易金额不一致
- **状态差异**：交易状态不一致
- **漏单**：系统内缺少交易记录
- **重复单**：系统内存在重复交易记录

### 4.4 退款管理

#### 4.4.1 退款流程
1. **退款申请**：用户或管理员提交退款申请
2. **退款审核**：财务人员审核退款申请
3. **发起退款**：系统调用支付平台的退款API
4. **退款处理**：支付平台处理退款请求
5. **退款回调**：支付平台通知系统退款结果
6. **订单更新**：系统更新订单状态和交易记录
7. **通知用户**：通知用户退款结果

#### 4.4.2 退款规则
- **退款金额**：根据业务规则确定退款金额
- **退款时限**：根据支付方式不同，退款到账时间为T+0至T+7
- **退款手续费**：根据支付平台规则，可能收取一定的退款手续费
- **退款次数**：同一订单支持多次部分退款

#### 4.4.3 退款查询
- **按退款单号查询**：查询退款详情
- **按订单号查询**：查询订单的所有退款记录
- **按状态查询**：查询特定状态的退款

### 4.5 批量支付

#### 4.5.1 应用场景
- **员工薪资发放**：每月批量向员工发放薪资
- **供应商付款**：批量向多个供应商付款

#### 4.5.2 批量支付流程
1. **数据准备**：准备批量支付的数据，包括收款人信息、金额等
2. **生成批量订单**：系统生成批量支付订单
3. **批量支付审核**：财务人员审核批量支付订单
4. **发起批量支付**：系统调用支付平台的批量支付API
5. **支付处理**：支付平台处理批量支付请求
6. **支付回调**：支付平台通知系统批量支付结果
7. **结果处理**：系统处理支付结果，更新相关记录
8. **通知收款人**：通知收款人支付结果

#### 4.5.3 批量支付管理
- **批量任务管理**：创建、查询、取消批量支付任务
- **任务进度查询**：查询批量支付任务的执行进度
- **失败处理**：处理批量支付中的失败记录
- **批量支付报表**：生成批量支付结果报表

## 5. 安全设计

### 5.1 数据安全

#### 5.1.1 敏感数据保护
- **加密存储**：支付相关的敏感数据加密存储
- **脱敏处理**：展示时对敏感数据进行脱敏处理
- **数据传输**：使用HTTPS加密传输数据

#### 5.1.2 密钥管理
- **密钥存储**：支付平台的API密钥安全存储
- **密钥轮换**：定期更换API密钥
- **权限控制**：只有授权人员可以访问密钥

### 5.2 交易安全

#### 5.2.1 交易验证
- **签名验证**：验证支付平台的签名，确保通知的真实性
- **订单验证**：验证订单的合法性，防止恶意请求
- **金额验证**：验证支付金额与订单金额是否一致

#### 5.2.2 防重复支付
- **幂等性设计**：确保同一订单不会被重复支付
- **支付锁定**：支付过程中对订单进行锁定
- **重复请求检测**：检测并拒绝重复的支付请求

#### 5.2.3 异常处理
- **超时处理**：处理支付超时的情况
- **网络异常**：处理网络异常导致的支付失败
- **系统异常**：处理系统异常导致的支付问题

### 5.3 访问控制

#### 5.3.1 权限管理
- **角色权限**：不同角色拥有不同的支付操作权限
- **操作权限**：精细到具体操作的权限控制
- **审批流程**：重要支付操作需要审批

#### 5.3.2 操作日志
- **记录内容**：记录所有支付相关的操作，包括操作人、操作时间、操作内容
- **日志查询**：支持按时间、操作人、操作类型查询日志
- **日志保留**：支付操作日志长期保留，用于审计

## 6. 接口设计

### 6.1 支付订单接口

#### 6.1.1 创建支付订单
- **URL**：`/api/payment/orders`
- **方法**：POST
- **参数**：
  - `amount`：支付金额
  - `payment_method`：支付方式（wechat/alipay/bank）
  - `order_type`：订单类型（customer_order/salary/supplier_payment）
  - `related_id`：关联ID
  - `description`：订单描述
- **响应**：
  ```json
  {
    "code": 201,
    "message": "订单创建成功",
    "data": {
      "order_id": "P202401010001",
      "amount": 100.00,
      "payment_method": "wechat",
      "payment_url": "weixin://wxpay/bizpayurl?pr=xxx",
      "expire_time": "2024-01-01T11:00:00"
    }
  }
  ```

#### 6.1.2 查询支付订单
- **URL**：`/api/payment/orders/<order_id>`
- **方法**：GET
- **响应**：
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "order_id": "P202401010001",
      "amount": 100.00,
      "payment_method": "wechat",
      "status": "paid",
      "create_time": "2024-01-01T10:00:00",
      "pay_time": "2024-01-01T10:05:00"
    }
  }
  ```

#### 6.1.3 取消支付订单
- **URL**：`/api/payment/orders/<order_id>/cancel`
- **方法**：POST
- **响应**：
  ```json
  {
    "code": 200,
    "message": "订单取消成功"
  }
  ```

### 6.2 退款接口

#### 6.2.1 创建退款订单
- **URL**：`/api/payment/refunds`
- **方法**：POST
- **参数**：
  - `order_id`：原支付订单号
  - `refund_amount`：退款金额
  - `refund_reason`：退款原因
- **响应**：
  ```json
  {
    "code": 201,
    "message": "退款申请成功",
    "data": {
      "refund_id": "R202401010001",
      "order_id": "P202401010001",
      "refund_amount": 50.00,
      "status": "processing"
    }
  }
  ```

#### 6.2.2 查询退款订单
- **URL**：`/api/payment/refunds/<refund_id>`
- **方法**：GET
- **响应**：
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "refund_id": "R202401010001",
      "order_id": "P202401010001",
      "refund_amount": 50.00,
      "status": "success",
      "refund_time": "2024-01-02T10:00:00"
    }
  }
  ```

### 6.3 批量支付接口

#### 6.3.1 创建批量支付任务
- **URL**：`/api/payment/batch`
- **方法**：POST
- **参数**：
  - `batch_type`：批量类型（salary/supplier）
  - `items`：批量支付项列表
  - `description`：批量支付描述
- **响应**：
  ```json
  {
    "code": 201,
    "message": "批量任务创建成功",
    "data": {
      "batch_id": "B202401010001",
      "batch_type": "salary",
      "total_amount": 50000.00,
      "total_count": 10,
      "status": "pending"
    }
  }
  ```

#### 6.3.2 查询批量支付任务
- **URL**：`/api/payment/batch/<batch_id>`
- **方法**：GET
- **响应**：
  ```json
  {
    "code": 200,
    "message": "查询成功",
    "data": {
      "batch_id": "B202401010001",
      "batch_type": "salary",
      "total_amount": 50000.00,
      "total_count": 10,
      "success_count": 9,
      "fail_count": 1,
      "status": "completed",
      "items": [
        {
          "id": 1,
          "recipient": "张三",
          "amount": 5000.00,
          "status": "success"
        }
      ]
    }
  }
  ```

### 6.4 支付回调接口

#### 6.4.1 微信支付回调
- **URL**：`/api/payment/callback/wechat`
- **方法**：POST
- **参数**：微信支付平台的回调参数
- **响应**：
  ```json
  {
    "code": "SUCCESS",
    "message": "成功"
  }
  ```

#### 6.4.2 支付宝回调
- **URL**：`/api/payment/callback/alipay`
- **方法**：POST
- **参数**：支付宝平台的回调参数
- **响应**：
  ```
  success
  ```

#### 6.4.3 银行卡支付回调
- **URL**：`/api/payment/callback/bank`
- **方法**：POST
- **参数**：银行卡支付平台的回调参数
- **响应**：
  ```json
  {
    "code": 200,
    "message": "处理成功"
  }
  ```

## 6. 微信小程序支付

### 6.1 客户端设计

#### 6.1.1 支付流程
1. **选择服务**：用户在小程序中选择服务
2. **确认订单**：确认订单金额和详情
3. **发起支付**：调用小程序支付API
4. **完成支付**：用户输入密码完成支付
5. **支付结果**：显示支付结果

#### 6.1.2 关键代码
```javascript
// 发起支付
wx.request({
  url: '/api/payment/orders',
  method: 'POST',
  data: {
    amount: 100,
    payment_method: 'wechat',
    order_type: 'customer_order',
    related_id: '1'
  },
  success: function(res) {
    const payParams = res.data.data.pay_params;
    // 调用微信支付API
    wx.requestPayment({
      timeStamp: payParams.timeStamp,
      nonceStr: payParams.nonceStr,
      package: payParams.package,
      signType: payParams.signType,
      paySign: payParams.paySign,
      success: function(res) {
        console.log('支付成功', res);
      },
      fail: function(res) {
        console.log('支付失败', res);
      }
    });
  }
});
```

### 6.2 管理端设计

#### 6.2.1 支付管理
- **订单管理**：查看和管理支付订单
- **交易记录**：查看交易记录
- **退款管理**：处理退款申请
- **批量支付**：发起员工薪资批量发放、供应商批量付款

#### 6.2.2 数据统计
- **支付概览**：显示支付总额、交易笔数等统计数据
- **支付趋势**：显示支付金额的变化趋势
- **支付方式分布**：显示不同支付方式的占比

## 7. 监控与运维

### 7.1 监控系统

#### 7.1.1 交易监控
- **实时监控**：实时监控支付交易的状态
- **异常预警**：当交易出现异常时及时预警
- **性能监控**：监控支付接口的响应时间

#### 7.1.2 系统监控
- **服务状态**：监控支付服务的运行状态
- **数据库状态**：监控数据库的运行状态
- **网络状态**：监控网络连接状态

### 7.2 日志系统

#### 7.2.1 系统日志
- **操作日志**：记录所有系统操作
- **错误日志**：记录系统错误
- **支付日志**：记录支付相关的详细日志

#### 7.2.2 日志分析
- **日志查询**：支持按条件查询日志
- **日志统计**：统计日志中的错误和异常
- **日志告警**：当出现严重错误时发出告警

### 7.3 故障处理

#### 7.3.1 故障类型
- **支付接口故障**：支付API调用失败
- **回调通知故障**：支付平台回调通知失败
- **数据库故障**：数据库连接或操作失败
- **网络故障**：网络连接中断

#### 7.3.2 故障处理流程
1. **故障检测**：监控系统检测到故障
2. **故障告警**：发出故障告警
3. **故障定位**：定位故障原因
4. **故障修复**：修复故障
5. **故障验证**：验证故障是否修复
6. **故障记录**：记录故障处理过程

## 8. 实施计划

### 8.1 开发阶段
1. **需求分析**：分析支付功能需求
2. **系统设计**：设计支付系统架构和接口
3. **接口对接**：对接微信支付、支付宝、银行卡支付API
4. **后端开发**：开发支付核心模块
5. **前端开发**：开发支付相关的前端界面
6. **测试**：进行功能测试、安全测试、性能测试
7. **上线**：部署支付功能到生产环境
8. **监控**：建立支付监控系统

### 8.2 测试计划
- **功能测试**：测试所有支付功能
- **安全测试**：测试支付系统的安全性
- **性能测试**：测试支付系统的性能和并发处理能力
- **兼容性测试**：测试不同浏览器、设备的兼容性
- **回归测试**：确保支付功能的稳定性

### 8.3 上线计划
- **灰度发布**：先在小范围内测试
- **全面上线**：支付功能全面上线
- **监控运维**：持续监控支付系统的运行状态
- **优化迭代**：根据用户反馈持续优化支付功能

## 9. 总结

本支付功能设计文档详细描述了餐食关系系统的支付模块，包括多渠道支付集成、全场景支付支持、支付核心模块设计和安全考虑。系统支持微信支付、支付宝和银行卡支付，覆盖客户预支付、餐费支付、员工薪资发放和供应商付款等场景。

通过本设计，系统将为用户提供便捷、安全、高效的支付体验，同时为企业提供完善的支付管理功能。支付模块的设计充分考虑了安全性、可靠性和可扩展性，确保系统能够满足企业的支付需求，并为未来的功能扩展做好准备。

支付功能是企业运营的重要组成部分，本设计方案旨在为餐食关系系统提供一个功能完善、安全可靠的支付模块，支持企业的日常运营和发展。