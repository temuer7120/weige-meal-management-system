# 客户服务记录查询统计和提示机制设计

## 1. 统计机制设计

### 1.1 服务记录统计

#### 1.1.1 统计维度

| 统计维度 | 描述 | 计算方法 | 展示方式 |
|---------|------|---------|--------|
| **服务类型分布** | 不同类型服务的数量和占比 | 按服务类型分组计数，计算占比 | 饼图、柱状图 |
| **服务时长统计** | 服务总时长、平均时长、最长/最短时长 | 计算服务时长总和、平均值、最大值、最小值 | 数值、柱状图 |
| **服务费用统计** | 服务总费用、平均费用、最高/最低费用 | 计算服务费用总和、平均值、最大值、最小值 | 数值、柱状图 |
| **服务满意度统计** | 服务评价的平均分和分布 | 计算服务评价的平均分，按评分等级分组计数 | 数值、饼图 |
| **服务状态分布** | 不同状态服务的数量和占比 | 按服务状态分组计数，计算占比 | 饼图、柱状图 |
| **服务人员工作量** | 不同服务人员的服务次数和时长 | 按服务人员分组计数和计算时长 | 柱状图、表格 |
| **服务时间分布** | 不同时间段的服务数量 | 按时间段分组计数 | 折线图、热力图 |

#### 1.1.2 统计方法

1. **SQL统计查询**：
   - 使用GROUP BY子句分组统计
   - 使用聚合函数计算总和、平均值、最大值、最小值
   - 使用COUNT函数计算数量
   - 使用CASE语句进行条件统计

2. **数据处理**：
   - 数据清洗：处理异常值和缺失值
   - 数据转换：将原始数据转换为统计所需格式
   - 数据聚合：按统计维度聚合数据

3. **统计结果存储**：
   - 实时计算：每次查询时实时计算统计结果
   - 定期计算：定期计算并存储统计结果，提高查询效率
   - 缓存存储：缓存统计结果，减少重复计算

#### 1.1.3 统计分析示例

1. **服务类型分布统计**：
   ```sql
   SELECT 
       si.name AS service_name, 
       COUNT(*) AS service_count, 
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM ServiceBooking WHERE booking_date BETWEEN :start_date AND :end_date), 2) AS percentage
   FROM 
       ServiceBooking sb
   JOIN 
       ServiceItem si ON sb.service_item_id = si.id
   WHERE 
       sb.booking_date BETWEEN :start_date AND :end_date
   GROUP BY 
       si.name
   ORDER BY 
       service_count DESC;
   ```

2. **服务时长统计**：
   ```sql
   SELECT 
       SUM(sb.duration_minutes) AS total_duration, 
       ROUND(AVG(sb.duration_minutes), 2) AS avg_duration, 
       MAX(sb.duration_minutes) AS max_duration, 
       MIN(sb.duration_minutes) AS min_duration
   FROM 
       ServiceBooking sb
   WHERE 
       sb.booking_date BETWEEN :start_date AND :end_date;
   ```

### 1.2 餐食记录统计

#### 1.2.1 统计维度

| 统计维度 | 描述 | 计算方法 | 展示方式 |
|---------|------|---------|--------|
| **餐食类型分布** | 不同类型餐食的数量和占比 | 按餐食类型分组计数，计算占比 | 饼图、柱状图 |
| **营养摄入统计** | 卡路里、蛋白质、维生素等营养成分的摄入量 | 计算营养成分的总和和平均值 | 数值、柱状图 |
| **餐食费用统计** | 餐食总费用、平均费用、最高/最低费用 | 计算餐食费用总和、平均值、最大值、最小值 | 数值、柱状图 |
| **餐食状态分布** | 不同状态餐食的数量和占比 | 按餐食状态分组计数，计算占比 | 饼图、柱状图 |
| **菜品偏好统计** | 客户偏好的菜品数量和占比 | 按菜品分组计数，计算占比 | 饼图、柱状图 |
| **餐食时间分布** | 不同时间段的餐食数量 | 按时间段分组计数 | 折线图、热力图 |
| **饮食限制统计** | 不同饮食限制的客户数量和占比 | 按饮食限制分组计数，计算占比 | 饼图、柱状图 |

#### 1.2.2 统计方法

1. **SQL统计查询**：
   - 使用GROUP BY子句分组统计
   - 使用聚合函数计算总和、平均值、最大值、最小值
   - 使用COUNT函数计算数量
   - 使用CASE语句进行条件统计

2. **数据处理**：
   - 数据清洗：处理异常值和缺失值
   - 数据转换：将原始数据转换为统计所需格式
   - 数据聚合：按统计维度聚合数据

3. **统计结果存储**：
   - 实时计算：每次查询时实时计算统计结果
   - 定期计算：定期计算并存储统计结果，提高查询效率
   - 缓存存储：缓存统计结果，减少重复计算

#### 1.2.3 统计分析示例

1. **餐食类型分布统计**：
   ```sql
   SELECT 
       cms.meal_type, 
       COUNT(*) AS meal_count, 
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM CustomerMenuSelection WHERE selection_date BETWEEN :start_date AND :end_date), 2) AS percentage
   FROM 
       CustomerMenuSelection cms
   WHERE 
       cms.selection_date BETWEEN :start_date AND :end_date
   GROUP BY 
       cms.meal_type
   ORDER BY 
       meal_count DESC;
   ```

2. **营养摄入统计**：
   ```sql
   SELECT 
       SUM(d.calories_per_serving) AS total_calories, 
       ROUND(AVG(d.calories_per_serving), 2) AS avg_calories
   FROM 
       CustomerMenuSelection cms
   JOIN 
       Dish d ON cms.dish_id = d.id
   WHERE 
       cms.selection_date BETWEEN :start_date AND :end_date;
   ```

### 1.3 孩子服务记录统计

#### 1.3.1 统计维度

| 统计维度 | 描述 | 计算方法 | 展示方式 |
|---------|------|---------|--------|
| **护理类型分布** | 不同类型护理的数量和占比 | 按护理类型分组计数，计算占比 | 饼图、柱状图 |
| **护理时长统计** | 护理总时长、平均时长、最长/最短时长 | 计算护理时长总和、平均值、最大值、最小值 | 数值、柱状图 |
| **生命体征趋势** | 生命体征的变化趋势 | 提取生命体征数据，计算平均值，按时间序列展示 | 折线图、表格 |
| **喂养记录统计** | 喂养次数、喂养量、喂养间隔 | 计算喂养次数、总量、平均间隔 | 数值、柱状图 |
| **睡眠记录统计** | 睡眠时间、睡眠质量、睡眠间隔 | 计算睡眠时间总和、平均值，分析睡眠质量 | 数值、柱状图 |
| **护理人员工作量** | 不同护理人员的护理次数和时长 | 按护理人员分组计数和计算时长 | 柱状图、表格 |
| **护理时间分布** | 不同时间段的护理数量 | 按时间段分组计数 | 折线图、热力图 |

#### 1.3.2 统计方法

1. **SQL统计查询**：
   - 使用GROUP BY子句分组统计
   - 使用聚合函数计算总和、平均值、最大值、最小值
   - 使用COUNT函数计算数量
   - 使用CASE语句进行条件统计

2. **JSON数据处理**：
   - 提取JSON格式的生命体征、喂养记录、睡眠记录数据
   - 解析JSON数据为结构化格式
   - 对解析后的数据进行统计分析

3. **统计结果存储**：
   - 实时计算：每次查询时实时计算统计结果
   - 定期计算：定期计算并存储统计结果，提高查询效率
   - 缓存存储：缓存统计结果，减少重复计算

#### 1.3.3 统计分析示例

1. **护理类型分布统计**：
   ```sql
   SELECT 
       ncr.care_type, 
       COUNT(*) AS care_count, 
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM NewbornCareRecord WHERE care_date BETWEEN :start_date AND :end_date), 2) AS percentage
   FROM 
       NewbornCareRecord ncr
   WHERE 
       ncr.care_date BETWEEN :start_date AND :end_date
   GROUP BY 
       ncr.care_type
   ORDER BY 
       care_count DESC;
   ```

2. **生命体征趋势分析**：
   - 提取生命体征数据
   - 解析JSON格式的生命体征数据
   - 按时间序列计算生命体征平均值
   - 生成生命体征趋势图表

### 1.4 工作量储备不足统计

#### 1.4.1 统计维度

| 统计维度 | 描述 | 计算方法 | 展示方式 |
|---------|------|---------|--------|
| **工作量负载率** | 实际工作量与可用工作量的比率 | 实际工作量 ÷ 可用工作量 × 100% | 数值、仪表盘、热力图 |
| **工作量储备不足率** | 工作量储备不足的程度 | (人力资源需求 - 工作量储备) ÷ 人力资源需求 × 100% | 数值、仪表盘、热力图 |
| **人员缺口** | 需要补充的员工数量 | 人力资源需求 ÷ 人均工作效率 - 现有员工数量 | 数值、柱状图 |
| **工时缺口** | 需要增加的工作时长 | 人力资源需求 × 人均工作效率 - 现有工时 | 数值、柱状图 |
| **任务积压** | 预计无法按时完成的任务数量 | 总任务数 - 可完成任务数 | 数值、柱状图 |
| **部门工作量分布** | 不同部门的工作量和负载率 | 按部门分组计算工作量和负载率 | 柱状图、表格 |
| **员工工作量分布** | 不同员工的工作量和负载率 | 按员工分组计算工作量和负载率 | 柱状图、表格 |

#### 1.4.2 统计方法

1. **SQL统计查询**：
   - 使用GROUP BY子句分组统计
   - 使用聚合函数计算总和、平均值、最大值、最小值
   - 使用COUNT函数计算数量
   - 使用CASE语句进行条件统计

2. **数据处理**：
   - 数据清洗：处理异常值和缺失值
   - 数据转换：将原始数据转换为统计所需格式
   - 数据聚合：按统计维度聚合数据

3. **统计结果存储**：
   - 实时计算：每次查询时实时计算统计结果
   - 定期计算：定期计算并存储统计结果，提高查询效率
   - 缓存存储：缓存统计结果，减少重复计算

#### 1.4.3 统计分析示例

1. **工作量负载率统计**：
   ```sql
   SELECT 
       wr.user_id, 
       u.full_name AS user_name, 
       SUM(wr.actual_hours) AS total_actual_hours, 
       SUM(wr.estimated_hours) AS total_estimated_hours, 
       ROUND(SUM(wr.actual_hours) / SUM(wr.estimated_hours) * 100, 2) AS workload_ratio
   FROM 
       WorkloadRecord wr
   JOIN 
       User u ON wr.user_id = u.id
   WHERE 
       wr.work_date BETWEEN :start_date AND :end_date
   GROUP BY 
       wr.user_id, u.full_name
   ORDER BY 
       workload_ratio DESC;
   ```

2. **工作量储备不足率统计**：
   - 计算人力资源需求
   - 计算工作量储备
   - 计算储备不足率
   - 生成储备不足率报表

## 2. 提示机制设计

### 2.1 预警提示类型

#### 2.1.1 服务相关预警

| 预警类型 | 描述 | 触发条件 | 预警级别 |
|---------|------|---------|--------|
| **服务到期提醒** | 即将到期的服务提醒 | 服务结束日期在未来7天内 | 信息级 |
| **服务逾期提醒** | 已逾期未完成的服务提醒 | 服务结束日期已过，状态未完成 | 警告级 |
| **服务质量预警** | 服务评价低于阈值的提醒 | 服务评价低于3星 | 警告级 |
| **服务预约冲突** | 服务时间冲突的提醒 | 同一服务人员在同一时间段有多个服务预约 | 严重级 |
| **服务资源不足** | 服务资源不足的提醒 | 服务预约数量超过服务资源容量 | 严重级 |

#### 2.1.2 餐食相关预警

| 预警类型 | 描述 | 触发条件 | 预警级别 |
|---------|------|---------|--------|
| **餐食到期提醒** | 即将到期的餐食提醒 | 餐食配送日期在未来3天内 | 信息级 |
| **餐食逾期提醒** | 已逾期未配送的餐食提醒 | 餐食配送日期已过，状态未配送 | 警告级 |
| **餐食库存不足** | 餐食用材库存不足的提醒 | 餐食用材库存低于预警阈值 | 严重级 |
| **餐食质量预警** | 餐食评价低于阈值的提醒 | 餐食评价低于3星 | 警告级 |
| **餐食需求异常** | 餐食需求异常波动的提醒 | 餐食需求量与历史平均值偏差超过50% | 警告级 |

#### 2.1.3 工作量相关预警

| 预警类型 | 描述 | 触发条件 | 预警级别 |
|---------|------|---------|--------|
| **工作量储备不足** | 工作量储备不足的提醒 | 工作量储备不足率超过5% | 警告级 |
| **工作量储备严重不足** | 工作量储备严重不足的提醒 | 工作量储备不足率超过10% | 严重级 |
| **员工工作量过载** | 员工工作量过载的提醒 | 员工工作量负载率超过120% | 警告级 |
| **员工工作量不足** | 员工工作量不足的提醒 | 员工工作量负载率低于50% | 信息级 |
| **工作量分配不平衡** | 工作量分配不平衡的提醒 | 团队成员工作量差异超过100% | 信息级 |

#### 2.1.4 孩子服务相关预警

| 预警类型 | 描述 | 触发条件 | 预警级别 |
|---------|------|---------|--------|
| **孩子健康预警** | 孩子生命体征异常的提醒 | 生命体征数据超出正常范围 | 严重级 |
| **护理到期提醒** | 即将到期的护理提醒 | 护理结束日期在未来7天内 | 信息级 |
| **护理逾期提醒** | 已逾期未完成的护理提醒 | 护理结束日期已过，状态未完成 | 警告级 |
| **护理质量预警** | 护理评价低于阈值的提醒 | 护理评价低于3星 | 警告级 |

### 2.2 预警提示机制

#### 2.2.1 预警触发机制

1. **实时预警**：
   - 在数据录入或更新时实时检查预警条件
   - 触发预警并立即通知相关人员

2. **定期预警**：
   - 定期执行预警检查任务
   - 汇总预警信息并通知相关人员

3. **查询预警**：
   - 在用户查询数据时检查预警条件
   - 在查询结果中展示预警信息

#### 2.2.2 预警通知方式

| 通知方式 | 描述 | 适用场景 | 实现方式 |
|---------|------|---------|--------|
| **系统通知** | 在系统内显示通知消息 | 所有预警 | 系统内消息中心、弹窗提醒 |
| **邮件通知** | 通过邮件发送预警信息 | 重要预警 | 邮件发送服务 |
| **短信通知** | 通过短信发送预警信息 | 紧急预警 | 短信发送服务 |
| **微信通知** | 通过微信发送预警信息 | 所有预警 | 微信公众号、企业微信 |
| **电话通知** | 通过电话发送预警信息 | 严重预警 | 语音电话服务 |

#### 2.2.3 预警处理流程

1. **预警生成**：
   - 检查预警条件
   - 生成预警记录
   - 确定预警级别
   - 选择通知方式

2. **预警通知**：
   - 发送预警通知
   - 记录通知状态
   - 跟踪通知送达情况

3. **预警处理**：
   - 接收预警信息
   - 确认预警
   - 分析预警原因
   - 制定处理方案
   - 执行处理方案

4. **预警跟踪**：
   - 跟踪处理进度
   - 更新预警状态
   - 记录处理结果
   - 评估处理效果

5. **预警归档**：
   - 处理完成后归档预警
   - 保留预警历史记录
   - 分析预警趋势

### 2.3 预警提示实现

#### 2.3.1 技术实现

1. **数据库触发器**：
   - 在数据插入或更新时触发预警检查
   - 生成预警记录

2. **定时任务**：
   - 使用定时任务定期执行预警检查
   - 生成预警记录并发送通知

3. **业务逻辑**：
   - 在业务逻辑中集成预警检查
   - 在数据处理过程中触发预警

4. **通知服务**：
   - 集成邮件发送服务
   - 集成短信发送服务
   - 集成微信通知服务
   - 集成电话通知服务

#### 2.3.2 预警配置

1. **预警阈值配置**：
   - 可配置的预警阈值
   - 不同级别预警的阈值设置
   - 基于历史数据的动态阈值调整

2. **预警规则配置**：
   - 可配置的预警规则
   - 基于条件的预警规则
   - 基于趋势的预警规则

3. **预警通知配置**：
   - 可配置的通知方式
   - 不同级别预警的通知方式
   - 通知接收人的配置

4. **预警处理配置**：
   - 可配置的预警处理流程
   - 不同级别预警的处理流程
   - 处理责任人的配置

#### 2.3.3 预警示例

1. **服务到期提醒**：
   ```sql
   SELECT 
       sb.booking_number, 
       c.name AS customer_name, 
       si.name AS service_name, 
       sb.end_date AS service_end_date,
       DATEDIFF(sb.end_date, CURRENT_DATE) AS days_until_end
   FROM 
       ServiceBooking sb
   JOIN 
       Customer c ON sb.customer_id = c.id
   JOIN 
       ServiceItem si ON sb.service_item_id = si.id
   WHERE 
       sb.status IN ('confirmed', 'in_progress')
       AND sb.end_date BETWEEN CURRENT_DATE AND DATE_ADD(CURRENT_DATE, INTERVAL 7 DAY);
   ```

2. **餐食库存不足提醒**：
   ```sql
   SELECT 
       i.id AS ingredient_id, 
       i.name AS ingredient_name, 
       i.current_stock, 
       i.minimum_stock,
       i.current_stock - i.minimum_stock AS stock_deficit
   FROM 
       Ingredient i
   WHERE 
       i.current_stock < i.minimum_stock;
   ```

3. **工作量储备不足提醒**：
   - 计算人力资源需求
   - 计算工作量储备
   - 计算储备不足率
   - 生成储备不足提醒

## 3. 统计和提示机制的集成

### 3.1 与查询功能的集成

1. **查询结果中的统计和提示**：
   - 在查询结果页面展示相关统计数据
   - 在查询结果页面展示相关预警提示
   - 提供统计数据的详细查看入口
   - 提供预警提示的详细查看入口

2. **查询条件与统计的关联**：
   - 根据查询条件调整统计维度
   - 根据查询条件调整预警检查范围
   - 提供统计条件的自定义配置

3. **查询结果与统计的导出**：
   - 支持导出查询结果和统计数据
   - 支持导出查询结果和预警提示
   - 提供多种导出格式（Excel、PDF、CSV）

### 3.2 与系统其他模块的集成

1. **与服务管理模块的集成**：
   - 服务管理模块的操作触发统计更新
   - 服务管理模块的操作触发预警检查
   - 统计和预警结果反馈到服务管理模块

2. **与餐食管理模块的集成**：
   - 餐食管理模块的操作触发统计更新
   - 餐食管理模块的操作触发预警检查
   - 统计和预警结果反馈到餐食管理模块

3. **与工作量管理模块的集成**：
   - 工作量管理模块的操作触发统计更新
   - 工作量管理模块的操作触发预警检查
   - 统计和预警结果反馈到工作量管理模块

4. **与报表模块的集成**：
   - 统计数据作为报表的数据源
   - 预警提示作为报表的内容
   - 提供基于统计和预警的自定义报表

### 3.3 前端展示设计

1. **统计数据展示**：
   - 仪表盘：展示关键统计指标
   - 图表：展示统计数据的分布和趋势
   - 表格：展示详细统计数据
   - 卡片：展示单个统计指标

2. **预警提示展示**：
   - 通知中心：展示所有预警提示
   - 徽章：展示预警提示的数量
   - 弹窗：展示紧急预警提示
   - 列表：展示预警提示的详细信息

3. **交互设计**：
   - 钻取：从汇总统计数据钻取到详细数据
   - 筛选：根据条件筛选统计数据和预警提示
   - 排序：对统计数据和预警提示进行排序
   - 导出：导出统计数据和预警提示

4. **响应式设计**：
   - 适配不同屏幕尺寸
   - 针对移动设备优化展示
   - 确保在各种设备上的良好体验

## 4. 性能优化

### 4.1 统计性能优化

1. **数据库优化**：
   - 为统计查询添加适当的索引
   - 优化统计查询语句
   - 使用数据库视图简化统计查询
   - 考虑使用列式存储数据库提高统计性能

2. **缓存优化**：
   - 缓存统计结果
   - 缓存频繁访问的统计数据
   - 合理设置缓存过期时间
   - 使用分布式缓存提高缓存容量和可靠性

3. **计算优化**：
   - 预计算统计结果
   - 定期计算统计结果
   - 使用异步计算减少查询等待时间
   - 使用并行计算提高计算速度

4. **数据采样**：
   - 对于大规模数据，使用数据采样进行统计
   - 基于采样数据估算总体统计结果
   - 提供采样误差的估计

### 4.2 预警性能优化

1. **预警检查优化**：
   - 优化预警检查算法
   - 减少预警检查的计算复杂度
   - 批量处理预警检查
   - 并行执行预警检查

2. **预警存储优化**：
   - 优化预警记录的存储结构
   - 为预警查询添加适当的索引
   - 定期清理过期预警记录
   - 归档历史预警记录

3. **预警通知优化**：
   - 批量发送预警通知
   - 优先级排序预警通知
   - 合并相似预警通知
   - 限流预警通知发送频率

4. **预警处理优化**：
   - 自动化预警处理流程
   - 提供预警处理的批量操作
   - 优化预警处理的审批流程
   - 提供预警处理的模板和建议

## 5. 测试和验证

### 5.1 统计功能测试

1. **功能测试**：
   - 测试所有统计维度的计算准确性
   - 测试不同查询条件下的统计结果
   - 测试统计数据的展示效果
   - 测试统计数据的导出功能

2. **性能测试**：
   - 测试大规模数据下的统计性能
   - 测试不同统计维度的计算时间
   - 测试统计缓存的效果
   - 测试统计预计算的效果

3. **边界测试**：
   - 测试空数据的统计结果
   - 测试异常数据的统计结果
   - 测试极端条件下的统计结果
   - 测试边界值的统计结果

### 5.2 预警功能测试

1. **功能测试**：
   - 测试所有预警类型的触发条件
   - 测试不同预警级别的通知方式
   - 测试预警处理流程的完整性
   - 测试预警状态的更新逻辑

2. **性能测试**：
   - 测试大规模数据下的预警检查性能
   - 测试预警通知的发送速度
   - 测试预警处理的响应时间
   - 测试预警存储的性能

3. **边界测试**：
   - 测试边界条件下的预警触发
   - 测试异常数据下的预警触发
   - 测试极端条件下的预警触发
   - 测试边界值的预警触发

### 5.3 集成测试

1. **与查询功能的集成测试**：
   - 测试查询结果与统计数据的一致性
   - 测试查询条件与统计维度的关联
   - 测试查询结果与预警提示的集成

2. **与其他模块的集成测试**：
   - 测试与服务管理模块的集成
   - 测试与餐食管理模块的集成
   - 测试与工作量管理模块的集成
   - 测试与报表模块的集成

3. **端到端测试**：
   - 测试完整的统计和提示流程
   - 测试用户操作的完整路径
   - 测试系统在实际使用场景下的表现

## 6. 总结

本设计文档详细描述了客户服务记录查询的统计和提示机制，包括服务记录统计、餐食记录统计、孩子服务记录统计和工作量储备不足统计的维度、方法和实现方式。同时，文档还设计了服务相关预警、餐食相关预警、工作量相关预警和孩子服务相关预警的类型、触发条件和处理流程，并提供了统计和提示机制的集成、性能优化和测试验证的建议。

通过合理设计统计和提示机制，可以提高客户服务记录查询的价值，为用户提供更全面、更深入的数据分析和预警功能，帮助用户更好地管理客户服务、餐食和工作量，提高服务质量和效率。